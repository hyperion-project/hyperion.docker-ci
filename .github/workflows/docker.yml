name: Docker CI

on:
  push:
    branches:
      - master

jobs:
  Docker:
    name: ${{ matrix.dockerOS }} ${{ matrix.dockerTag }} ${{ matrix.description }}
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        dockerImage: [ x86_64, armv6l, armv7l, aarch64 ]
        dockerTag: [ buster, bullseye, bookworm ]
        include:
          - dockerImage: x86_64
            dockerOS: Debian
            description: (x86_64)
            os: ubuntu-latest
          - dockerImage: armv6l
            dockerOS: Debian
            description: (Raspberry Pi v1 & ZERO)
            os: ubuntu-latest
          - dockerImage: armv7l
            dockerOS: Debian
            description: (Raspberry Pi 2, 3 & 4)
            os: ubuntu-latest
          - dockerImage: aarch64
            dockerOS: Debian
            description: (Generic AARCH64)
            os: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: set lower case actor name for docker build
        run: |
          echo "ACTOR_LC=${ACTOR,,}" >> ${GITHUB_ENV}
        env:
          ACTOR: '${{ github.actor }}'

      - name: Build and tag docker image
        run: |
          if [ '${{ github.repository }}' == 'hyperion-project/hyperion.docker-ci' ]; then
            docker build -t ghcr.io/hyperion-project/${{ matrix.dockerImage }}:${{ matrix.dockerTag }} --build-arg SUITE=${{ matrix.dockerTag }} -f ${{ matrix.dockerImage }} .
          else
            docker build -t ghcr.io/${{ env.ACTOR_LC }}/${{ matrix.dockerImage }}:${{ matrix.dockerTag }} --build-arg SUITE=${{ matrix.dockerTag }} --build-arg REPOSITORY="${{ github.server_url }}/${{ github.actor }}" -f ${{ matrix.dockerImage }} .
          fi

      - name: Publish to GitHub Container/Package Registry
        env:
            SECRET_DOCKER_CI: ${{ secrets.DOCKER_CI }}
        if: ${{ env.SECRET_DOCKER_CI != null }}
        run: |
          echo ${{ secrets.DOCKER_CI }} | docker login ghcr.io -u ${{ github.actor }} --password-stdin
          if [ '${{ github.repository }}' == 'hyperion-project/hyperion.docker-ci' ]; then
            docker push ghcr.io/hyperion-project/${{ matrix.dockerImage }}:${{ matrix.dockerTag }}
          else
            docker push ghcr.io/${{ env.ACTOR_LC }}/${{ matrix.dockerImage }}:${{ matrix.dockerTag }}
          fi
